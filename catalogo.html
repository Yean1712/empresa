<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatÃ¡logo | Ninja Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header-fixed" style="position: relative; background: #000;">
        <nav>
            <div class="logo"><img src="logo.jpg" class="nav-logo"> NINJA STORE</div>
            <div class="nav-links">
                <a href="index.html">Inicio</a>
                <a href="catalogo.html" class="active-link">CatÃ¡logo</a>
                <a href="login.html" id="auth-link">Entrar</a>
            </div>
        </nav>
    </header>

    <section class="catalog-content">
        <input type="text" id="searchInput" placeholder="Buscar modelo..." onkeyup="searchProduct()">
        
        <div class="category-filters">
            <button class="filter-btn active" onclick="filterCategory('all', event)">Todos</button>
            <button class="filter-btn" onclick="filterCategory('offer', event)">Ofertas ðŸ”¥</button>
            <button class="filter-btn" onclick="filterCategory('apple', event)">iPhone</button>
            <button class="filter-btn" onclick="filterCategory('android', event)">Android</button>
            <button class="filter-btn" onclick="filterCategory('acc', event)">Accesorios</button>
        </div>

        <div class="products-grid" id="productGrid"></div>
    </section>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth.js"></script>

    <script>
        // SEGURIDAD: Solo permite ver el catÃ¡logo si hay un usuario logueado
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                cargarProductosDesdeFirebase();
            }
        });

        function cargarProductosDesdeFirebase() {
            const grid = document.getElementById('productGrid');
            db.collection("productos").onSnapshot((snapshot) => {
                grid.innerHTML = "";
                snapshot.forEach((doc) => {
                    const p = doc.data();
                    grid.innerHTML += `
                        <div class="product-card" data-category="${p.categoria}">
                            <img src="${p.imagen}" onerror="this.src='logo.jpg'">
                            <div class="product-info">
                                <h4>${p.nombre}</h4>
                                <p class="price">$${p.precio}</p>
                                <button onclick="sendWA('${p.nombre}', '${p.precio}')" class="btn-whatsapp">
                                    WhatsApp
                                </button>
                            </div>
                        </div>`;
                });
            });
        }

        function sendWA(p, pr) {
            const user = firebase.auth().currentUser;
            db.collection("compras").add({
                userId: user.uid,
                userName: user.displayName || "Usuario Ninja",
                producto: p,
                precio: pr,
                fecha: new Date().toLocaleString()
            }).then(() => {
                const mensaje = `Hola! Soy ${user.displayName}. Me interesa el ${p} ($${pr})`;
                window.open(`https://wa.me/584247531915?text=${encodeURIComponent(mensaje)}`, '_blank');
            });
        }

        function filterCategory(c, e) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.product-card').forEach(item => {
                const cat = item.getAttribute('data-category');
                item.style.display = (c === 'all' || cat === c) ? 'block' : 'none';
            });
        }

        function searchProduct() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.product-card').forEach(card => {
                let name = card.querySelector('h4').innerText.toLowerCase();
                card.style.display = name.includes(input) ? "block" : "none";
            });
        }
    </script>
</body>
</html>